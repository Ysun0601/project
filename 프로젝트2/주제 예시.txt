시나리오 : C2 통신 탐지 및 대응
목표 : 악성 도메인과의 통신을 탐지하고, C2(Command and Control) 통신 시도를 차단하여 데이터 유출 방지
C2 : 공격자가 초기 침투에 성공한 장치와의 통신을 유지하는 데 사용하는 도구 및 기술 집합

1. 보안 모니터링
목표 : 네트워크와 리소스의 활동을 지속적으로 모니터링하여 비정상적인 동작을 실시간으로 수집.

사용 기술과 역할
(1). Route 53 Resolver Query Logs - DNS 요청을 추적하여 C2 서버와의 통신을 탐지
(2). Amazon VPC Flow Logs - VPC 내에서 송수신되는 네트워크 트래픽을 기록
                                 - 악성 도메인으로 접속 시도는 네트워크 트래픽으로 나타나며, 
                                    C2 서버와의 실제 데이터 전송은 IP와 포트를 통해 이루어집니다.
                                 - VPC Flow Logs는 소스/목적지 IP, 포트, 프로토콜 정보를 기록하여 비정상 트래픽을 식별
(3). AWS CloudTrail - API 호출 기록을 추적 공격자는 C2 통신을 사용해
                          감염된 리소스의 IAM 권한을 변경하거나 리소스를 추가로 악용
                       - CloudTrail은 IAM 권한 변경, 보안 그룹 수정, 
                          새로운 EC2 생성과 같은 API 호출을 기록하여 비정상적인 리소스 활동을 탐지
-----------------------------------------------------------------------------------------------------------------------
위에 단계가 모두 NIDS 역할 - 네트워크 트래픽 및 DNS 요청 데이터를 수집하여 비정상적인 행동을 탐지할 준비.
Threat Intelligence 역할 - Threat Intelligence는 이 단계에서 직접 개입하지 않지만, 
                                수집된 데이터(악성 도메인 및 IP)의 탐지 신뢰도를 높이는 기준으로 사용
------------------------------------------------------------------------------------------------------------------------
2. 보안 탐지
목표 : DNS 요청, 네트워크 로그, 리소스 활동 로그를 기반으로 비정상적인 트래픽 및 동작 탐지
사용 기술과 역할
(1) Amazon GuardDuty - VPC Flow Logs, DNS Query Logs, CloudTrail 데이터 분석.
                             - 악성 도메인과 연계된 DNS 요청 탐지
                             - 비정상적인 네트워크 트래픽 및 데이터 유출 시도 탐지
NIDS 역할 - C2 통신 관련 이상 트래픽 탐지 및 이벤트 생성.

(2) AWS Security Hub - 탐지 결과를 통합 관리
                            - GuardDuty 결과를 위협 인텔리전스와 연계하여 심각도 분석.
                            - 서드파티 위협 인텔리전스 피드를 사용해 악성 도메인 여부 확인
Threat Intelligence 역할 - GuardDuty 탐지 결과를 위협 인텔리전스와 연계하여 악성 도메인 여부 확인.
3. 보안 로그 분석
목표 : 수집된 로그 데이터를 정리하여 심층 분석 가능하게 처리
사용 기술과 역할
(1) Amazon S3 - VPC Flow Logs, Route 53 Logs, CloudTrail 데이터를 중앙 집중식으로 저장
(2) AWS Glue - S3에 저장된 로그를 정리하고, 분석 도구로 전달할 수 있도록 처리.
(3) Amazon Athena - 정리된 데이터를 쿼리하여 이상 트래픽 패턴 분석
NIDS 역할 - 수집된 네트워크 트래픽 데이터를 정리하여 이상 활동에 대한 정보를 제공합니다
Threat Intelligence 역할 - Threat Intelligence는 로그 데이터를 상관분석하여, 탐지된 IP/도메인이 알려진 위협인지 확인

4. 분석 데이터 시각화
목표 : 로그와 탐지 데이터를 시각화하여 공격 패턴을 가시적으로 파악
사용 기술과 역할
(1) Amazon OpenSearch Service - 주요 악성 도메인 요청, C2 서버 통신 시도, 감염된 인스턴스 등 시각화.
NIDS 역할: 탐지 결과를 시각화하여 C2 통신의 전체 패턴을 확인
Threat Intelligence 역할: 위협 인텔리전스 데이터를 기반으로 시각화 데이터의 신뢰도를 높임

5. 보안 대응 자동화
목표 : 탐지된 위협에 대해 자동화된 조치를 수행하여 위협을 차단
사용 기술과 역할
(1)Amazon EventBridge - GuardDuty 또는 Security Hub에서 발생한 "High Severity" 이벤트를 Lambda로 전달
(2)AWS Lambda - 악성 도메인 요청을 시도한 인스턴스를 격리(Security Group 변경
(3)Amazon SNS - 탐지 및 대응 결과를 이메일 또는 SMS로 보안팀에 전송.
NIDS 역할: C2 통신 탐지 이벤트를 기반으로 자동화된 대응을 시작
Threat Intelligence 역할: AWS WAF - Lambda를 통해 WAF 블록리스트 업데이트, 악성 IP가 포함된 트래픽을 실시간 차단

6. 보안 강화
목표 : 위협 탐지 및 대응 프로세스를 지속적으로 개선하고 보안 정책 강화
(1)AWS Config - 네트워크 설정 변경 기록, 보안 그룹 규칙이 예상치 못하게 변경되었는지 확인.
NIDS 역할: 탐지 규칙 및 로그 모니터링 규칙 개선.
              GuardDuty 탐지 규칙을 지속적으로 업데이트하여 오탐/과탐 최소화

Threat Intelligence 역할: 서드파티 위협 피드와 연계해 AWS WAF 및 GuardDuty 규칙을 최적화.
                               IAM Access Analyzer로 감염된 인스턴스의 권한을 재검토하여 추가 피해 방지
-------------------------------------------------------------------------------------------------------------
NIDS (Network Intrusion Detection System) - 보안 모니터링과 보안 탐지에 해당.
* 네트워크와 트래픽 기반 이상 탐지.
* C2 통신 시도를 식별하기 위한 비정상적인 트래픽 패턴 분석

Threat Intelligence - 보안 탐지, 보안 로그 분석, 보안 강화 단계.
* NIDS 탐지 결과의 신뢰성 검증.
* 탐지된 이벤트가 실제 위협인지 확인.
* 악성 도메인, IP, 해시값과 같은 위협 데이터 제공.
* 위협 차단 리스트(WAF, 블록리스트 등) 업데이트.

C2 통신 시나리오가 더 효과적인 경우:
보안 중심 조직: C2 통신 시나리오가 더 효과적
데이터 유출 방지 및 내부 시스템 보호에 초점.
DNS 기반 탐지와 GuardDuty의 정밀 탐지 기능을 활용.

NIDS + 위협 인텔리전스 결합의 효과와 한계
신뢰도 향상
 - 탐지된 이벤트가 실제 위협인지 판단하는 데 도움.

경고 우선순위 설정
 - Security Hub 또는 OpenSearch를 활용해 중요도가 높은 위협을 먼저 처리.

Threat Intelligence는 정적 데이터로 작동하며, 주기적인 업데이트를 기반으로 하므로, 
실시간 위협 탐지에는 한계가 있습니다
위협 데이터가 빠르게 변경되는 상황(예: C2 서버 IP가 자주 변경)에서 탐지와 대응이 늦어질 수 있습니다

NIDS의 보완 가능성
C2 통신 중 도메인/IP가 변경되더라도, 비정상적인 요청 패턴을 기반으로 위협 탐지 가능
-----------------------------------------------------------------------------------------------------------------